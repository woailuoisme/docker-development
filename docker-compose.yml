networks:
  frontend:
    name: frontend
  backend:
    name: backend

volumes:
  app_code:
    name: app_code
    driver: local
    driver_opts:
      type: bind
      source: ${APP_CODE_PATH}
      o: bind,rw

services:

  dnsmasq:
    build:
      context: ./dnsmasq
    container_name: dnsmasq
    restart: always
    ports:
      - "5354:53/udp"
      - "5354:53/tcp"
    cap_add:
      - NET_ADMIN
    networks:
      - backend

  caddy:
    build:
      context: ./caddy
    container_name: caddy
    environment:
      - SITE_ADDRESS=${SITE_ADDRESS}
      - AWS_ACCESS_KEY_ID=${ALIYUN_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${ALIYUN_ACCESS_KEY_SECRET}
      - ALIYUN_ACCESS_KEY_ID=${ALIYUN_ACCESS_KEY_ID}
      - ALIYUN_ACCESS_KEY_SECRET=${ALIYUN_ACCESS_KEY_SECRET}
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "8080:8080"
#      - "8883:8883"  # MQTT over TLS (Layer4)
#      - "22375:2375"
#      - "25432:25432"
#      - "26379:26379"`
    volumes:
      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
      - ${CONFIG_PATH}caddy:/etc/caddy
      - ${DATA_PATH}caddy:/data/caddy
      - ${LOG_PATH}caddy:/srv/logs  # 将日志持久化到宿主机 ./logs 目录
#     mv data/caddy/caddy/* data/caddy/ && rmdir data/caddy/caddy
    restart: always
    depends_on:
      - dozzle
      - authelia
      - roadrunner
      - fpm
    networks:
      - frontend
      - backend

  go-access:
    build:
      context: ./go-access
    container_name: go-access
    restart: always
    volumes:
      - ${LOG_PATH}caddy:/srv/logs  # 挂载 Caddy 的日志目录
    environment:
      - GOACCESS_WS_URL=wss://clogs.${SITE_ADDRESS}:443
      - GOACCESS_OUTPUT=/srv/logs/report.html
    depends_on:
      - caddy
    networks:
      - backend

  authelia:
    build:
      context: ./authelia
    container_name: authelia
    restart: always
    ports:
      - "9091:9091"
    volumes:
      - ${CONFIG_PATH}authelia/config:/config
    environment:
      - X_AUTHELIA_CONFIG_FILTERS=template
      - TZ=${TIMEZONE}
      - DOMAIN=${SITE_ADDRESS}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RESEND_API_KEY=${RESEND_API_KEY}
    networks:
      - frontend
      - backend

  fpm:
    build:
      context: ./php-fpm
      dockerfile: Dockerfile
      args:
        - CHANGE_SOURCE=${CHANGE_SOURCE}
        - WWWUSER=${WWWUSER:-33}
        - WWWGROUP=${WWWGROUP:-33}
    container_name: fpm
    restart: always
    volumes:
      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
      - ${CONFIG_PATH}ssh:/home/www-data/.ssh:ro
    environment:
      - APP_PATH=${APP_PATH}
      - APP_ENV=${APP_ENV}
      - APP_DEBUG=true
      - ENABLE_SUPERVISOR=false
      - ENABLE_SCHEDULE=false
      - ENABLE_HORIZON=false
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - backend
      - frontend
    depends_on:
      - redis
      - postgres
      - meilisearch
      - minio

#  php-franken:
#    build:
#      context: php-franken
#    container_name: php-franken
#    restart: always
#    ports:
#      - "8801:8001"
#      - "12019:2019"
#    volumes:
#      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
#      - ${CONFIG_PATH}ssh:/home/www-data/.ssh:ro
#    environment:
#      - APP_PATH=${APP_PATH}
#      - APP_ENV=${APP_ENV}
#      - APP_DEBUG=false
#      - ENABLE_SUPERVISOR=false
#      - WATCH=fasle
#      - OCTANE_POLL=false
#      - OCTANE_WORKERS=4
#      - OCTANE_MAX_REQUESTS=300
#    networks:
#      - backend
#      - frontend
#    depends_on:
#      - redis
#      - postgres
#      - minio
#      - meilisearch
#      - php-horizon
#      - php-schedule

  roadrunner:
    build:
      context: php-roadrunner
    container_name: roadrunner
    restart: always
    environment:
      - APP_PATH=${APP_PATH}
      - APP_ENV=${APP_ENV}
      - APP_DEBUG=false
      - OCTANE_WORKERS=4
      - OCTANE_MAX_REQUESTS=500
      - WATCH=false
      - ENABLE_SUPERVISOR=false
    ports:
      - "8201:8001"
    volumes:
      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
      - ${CONFIG_PATH}ssh:/home/www-data/.ssh:ro
    networks:
      - backend
      - frontend
    depends_on:
      - redis
      - postgres
      - minio
      - meilisearch
      - horizon
      - schedule

  horizon:
    build:
      context: php-horizon
    container_name: horizon
    restart: always
    environment:
      - APP_PATH=${APP_PATH}
      - APP_ENV=${APP_ENV}
      - ENABLE_SUPERVISOR=false
    volumes:
      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
    networks:
      - backend
    depends_on:
      - redis

  schedule:
    build:
      context: php-schedule
    container_name: schedule
    restart: always
    environment:
      - APP_PATH=${APP_PATH}
      - APP_ENV=${APP_ENV}
      - ENABLE_SUPERVISOR=false
    volumes:
      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
    networks:
      - backend
    depends_on:
      horizon:
        condition: service_started

#  php-reverb:
#    build:
#      context: php-reverb
#    container_name: php-reverb
#    restart: always
#    environment:
#      - APP_PATH=${APP_PATH}
#      - APP_ENV=${APP_ENV}
#      - ENABLE_SUPERVISOR=false
#    volumes:
#      - ${APP_CODE_PATH}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
#    networks:
#      - backend
#    depends_on:
#      - redis
#      - php-horizon

#  postgres:
#    build:
#      context: ./postgres17
#      args:
#        - POSTGRES_VERSION=17.6-alpine
#    container_name: postgres
#    restart: always
#    volumes:
#      - ${CONFIG_PATH}postgres17/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
#      - ${DATA_PATH}postgres:/var/lib/postgresql/data
#    ports:
#      - "25432:5432"
##      - "45432:5432"
#    environment:
#      - POSTGRES_USER=${POSTGRES_USER}
#      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
#      - POSTGRES_DB=${POSTGRES_DB}
#      # 配置档案选择: 1c1g, 2c2g, 4c8g, custom
#      - POSTGRES_CONFIG_PROFILE=${POSTGRES_CONFIG_PROFILE:-1c1g}
#      # 自定义配置文件路径（仅当 POSTGRES_CONFIG_PROFILE=custom 时使用）
#      # - POSTGRES_CUSTOM_CONFIG=/etc/postgresql/custom.conf
#    networks:
#      - backend
#      - frontend

  postgres:
    container_name: postgres
    build:
      context: postgres18
      args:
        - POSTGRES_VERSION=18.1-alpine3.23
    restart: always
    ports:
      - "45432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      # PostgreSQL 18 推荐方式：挂载父目录
      # 数据将存储在: data/postgres18/18/docker/
      # 这是官方推荐的方式，便于未来版本升级
      - ${DATA_PATH}postgres18:/var/lib/postgresql
      - ${CONFIG_PATH}postgres18/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    networks:
      - backend
      - frontend

#  pgbouncer:
#    build:
#      context: ./pgbouncer
#      args:
#        CHANGE_SOURCE: ${CHANGE_SOURCE:-false}
#    container_name: pgbouncer
#    restart: always
#    ports:
#      - "${PGBOUNCER_PORT:-15432}:15432"
#    environment:
#      - POSTGRES_HOST=postgres
#      - POSTGRES_PORT=5432
#      - POSTGRES_DB=${POSTGRES_DB}
#      - POSTGRES_USER=${POSTGRES_USER}
#      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
#    networks:
#      - backend
#    depends_on:
#      - postgres

  redis:
    container_name: redis
    build:
      context: ./redis
      args:
        - REDIS_VERSION=${REDIS_VERSION}
    volumes:
      - ${DATA_PATH}redis:/data
    restart: always
    command: --requirepass ${REDIS_PASSWORD}
    ports:
      - "46379:6379"
    networks:
      - backend
      - frontend

  meilisearch:
    build:
      context: ./meilisearch
      args:
        - TIMEZONE=${TIMEZONE:-Asia/Shanghai}
        - MEILI_VERSION=${MEILI_VERSION:-v1.31}
    container_name: meilisearch
    restart: always
    command: meilisearch --config-file-path /meili_config/config.toml
    environment:
      - TZ=${TIMEZONE:-Asia/Shanghai}
#      - MEILI_ENV=production
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_NO_ANALYTICS=true
      - MEILI_MAX_INDEXING_MEMORY=256Mb
      - MEILI_HTTP_PAYLOAD_SIZE_LIMIT=100Mb
    ports:
      - "${SEARCH_PORT:-7700}:7700"
    volumes:
      - ${DATA_PATH}meili_data:/meili_data
      # 可选：挂载配置文件以便动态修改
      - ${CONFIG_PATH}meilisearch/config.toml:/meili_config/config.toml:ro
    networks:
      - frontend
      - backend

  minio:
    build:
      context: ./minio
    container_name: minio
    restart: always
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - "${DATA_PATH}/minio:/data"
    ports:
      - "${MINIO_PORT_UI}:9001"
      - "${MINIO_PORT}:9000"
    networks:
      - backend

#  mongodb:
#    build:
#      context: ./mongodb
#      args:
#        - MONGO_VERSION=${MONGO_VERSION:-8.0}
#    container_name: mongodb
#    restart: always
#    environment:
#      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_ROOT_USER:-admin}
#      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD:-password}
#    volumes:
#      - ${DATA_PATH}mongodb:/data/db
#    ports:
#      - "${MONGODB_PORT:-27017}:27017"
#    networks:
#      - backend
#      - frontend

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:v8.14
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8180:8080"
    environment:
      - TZ=Asia/Shanghai
      - DOZZLE_LEVEL=info
      - DOZZLE_FILTER=status=running
      - DOZZLE_NO_ANALYTICS=true
    healthcheck:
      test: ["CMD", "/dozzle", "healthcheck"]
      interval: 3s
    networks:
      - backend
      - frontend
#  docs:
#    build: ./website
#    container_name: docs
#    restart: always
#    volumes:
#      - ${DOCS_PATH}/.vitepress/dist:/usr/share/nginx/html:ro
#    ports:
#      - "8090:80"
#    networks:
#      - backend
#      - frontend
  mysql:
    build:
      context: ./mysql8
      args:
        - MYSQL_VERSION=8.4
    container_name: mysql
    restart: always
    stop_grace_period: 1m
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: ${TIMEZONE:-Asia/Shanghai}
    ports:
      - "43306:3306"
    volumes:
      - ${DATA_PATH}mysql8:/var/lib/mysql
      - ${CONFIG_PATH}mysql8/conf.d:/etc/mysql/conf.d
      - ${CONFIG_PATH}mysql8/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    networks:
      - backend

#  ntfy:
#    image: binwiederhier/ntfy
#    container_name: ntfy
#    command:
#      - serve
#    environment:
#      - TZ=Asia/Shanghai
#    volumes:
#      - /var/cache/ntfy:/var/cache/ntfy
#      - ${CONFIG_PATH}ntfy:/etc/ntfy
#    ports:
#      - "11180:80"
#    restart: always
#    networks:
#      - backend
#      - frontend

#  docker-proxy:
#    build:
#      context: ./docker-proxy
#    container_name: docker-proxy
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    restart: always
#    privileged: true
#    ports:
#      - "42375:2375"
#    security_opt:
#      - no-new-privileges:true
#    networks:
#      - backend
#      - frontend

#  homepage:
#    image: ghcr.io/gethomepage/homepage:v1.8
#    container_name: homepage
#    environment:
#      HOMEPAGE_ALLOWED_HOSTS: "home.${SITE_ADDRESS}"
#      HOMEPAGE_VAR_SITE_ADDRESS: ${SITE_ADDRESS}
#      HOMEPAGE_VAR_DOMAIN: ${SITE_ADDRESS}
#    ports:
#      - "33000:3000"
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#      - ${CONFIG_PATH}homepage:/app/config
#    restart: always
#    networks:
#      - frontend
#      - backend

#  gotify:
#    image: gotify/server:2.8
#    container_name: gotify
#    restart: always
#    ports:
#      - "8380:80"
#    environment:
#      - GOTIFY_DEFAULTUSER_NAME=${GOTIFY_DEFAULTUSER_NAME}
#      - GOTIFY_DEFAULTUSER_PASS=${GOTIFY_DEFAULTUSER_PASS}
#      - TZ=Asia/Shanghai
#    volumes:
#      - "${DATA_PATH}gotify:/app/data"
#    networks:
#      - backend

#  centrifugo:
#    image: centrifugo/centrifugo:v6
#    container_name: centrifugo
#    command: centrifugo -c /centrifugo/config.yaml --log.level=info
#    ports:
#      - "8500:8000"
#    volumes:
#      - ${CONFIG_PATH}centrifugo:/centrifugo
#    environment:
#      # 安全配置 - v6 新格式
#      - CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY=${CENTRIFUGO_TOKEN_HMAC_SECRET_KEY}
#      - CENTRIFUGO_HTTP_API_KEY=${CENTRIFUGO_API_KEY}
#      # 管理后台
#      - CENTRIFUGO_ADMIN_PASSWORD=${CENTRIFUGO_ADMIN_PASSWORD}
#      - CENTRIFUGO_ADMIN_SECRET=${CENTRIFUGO_ADMIN_SECRET}
#      # Redis 连接（生产环境）
#      # 格式: redis://[:password@]host:port/db
#      - CENTRIFUGO_ENGINE_REDIS_ADDRESS=redis://:${REDIS_PASSWORD}@redis:6379/2
#    ulimits:
#      nofile:
#        soft: 65536
#        hard: 65536
#    restart: always
#    networks:
#      - backend
#      - frontend
#    depends_on:
#      - redis

#  wud:
#    image: getwud/wud:8.1.1
#    container_name: wud
#    env_file: .env.wud
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
#      - /etc/localtime:/etc/localtime:ro
#    ports:
#      - "3200:3000"
#    restart: always
#    networks:
#      - backend
#      - frontend

#  mosquitto:
#    build: ./mosquitto
#    container_name: mosquitto
#    ports:
#      - "${MQTT_PORT:-1883}:1883"      # MQTT 明文端口
#      - "${MQTT_TLS_PORT:-8883}:8883"  # MQTTS 加密端口
#    volumes:
#      - ${CONFIG_PATH}/mosquitto/config:/mosquitto/config
#      - ${DATA_PATH}mosquitto/data:/mosquitto/data
#      - ${LOG_PATH}mosquitto/log:/mosquitto/log
#      - ${DATA_PATH}caddy/certificates:/mosquitto/certs  # Caddy 证书（只读）
#    environment:
#      - MQTT_USERNAME=${MQTT_USERNAME}
#      - MQTT_PASSWORD=${MQTT_PASSWORD}
#      - MQTT_ALLOW_ANONYMOUS=${MQTT_ALLOW_ANONYMOUS:-false}
#      - SITE_ADDRESS=${SITE_ADDRESS}
#    networks:
#      - backend
#      - frontend

#  beszel:
#    image: henrygd/beszel:latest
#    container_name: beszel
#    restart: always
#    environment:
#      - ADMIN_EMAIL=admin@example.com
#      - ADMIN_PASSWORD=admin@example.com
#    ports:
#      - "8090:8090"
#    volumes:
#      - ${DATA_PATH}beszel:/beszel_data
#    healthcheck:
#      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090"]
#      interval: 30s
#      timeout: 5s
#      retries: 3
#      start_period: 10s
#    networks:
#      - backend
#      - frontend
#
#  beszel-agent:
#    image: henrygd/beszel-agent:latest
#    container_name: beszel-agent
#    restart: always
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#      - ${DATA_PATH}beszel_agent:/var/lib/beszel-agent
#      # monitor other disks / partitions by mounting a folder in /extra-filesystems
##      - /mnt/disk/.beszel:/extra-filesystems/sda1:ro
#    environment:
#      LISTEN: 45876
#      KEY: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIN7U3WmswR2GGyV/Q8MA2MPD/toJ9/9F2phZ/CgRgERE'
#      TOKEN: f8584037-db71-49ec-b14c-8ccd4e25b8ce
#      # 使用容器名称和内部端口，不走 Caddy
#      HUB_URL: http://beszel:8090
#    healthcheck:
#      test: ["CMD", "/agent", "health"]
#      interval: 30s
#      timeout: 5s
#      retries: 3
#      start_period: 10s
#    networks:
#      - backend
#      - frontend



