; ============================================================================
; OPcache 字节码缓存配置 - 生产环境优化 (RoadRunner/Laravel)
; 生产环境特点：代码不可变、极致性能、JIT 开启、内存最大化
; ============================================================================

; 启用 OPcache
opcache.enable=1

; 启用 CLI 模式的 OPcache（RoadRunner/Octane 必须启用）
; RoadRunner 作为 CLI 进程运行，不启用会导致性能减半
opcache.enable_cli=1

; ============================================================================
; JIT (Just-In-Time) 编译器配置 (PHP 8.0+)
; ============================================================================
; 在生产环境中启用 JIT 可以显著提升 CPU 密集型任务的性能
; 默认使用 tracing 模式，适用于大多数 web 应用
opcache.jit=tracing

; JIT 缓冲区大小
; 分配给 JIT 编译代码的内存空间
opcache.jit_buffer_size=128M

; ============================================================================
; 内存与文件数量配置
; ============================================================================

; OPcache 共享内存大小（MB）
; 生产环境建议分配充足内存，避免缓存逐出
opcache.memory_consumption=256

; 驻留字符串缓冲区大小（MB）
; 现代框架（如 Laravel）字符串较多，建议调大
opcache.interned_strings_buffer=64

; 最大缓存脚本数量
; 包含项目文件 + Vendor 文件，建议设置较大值以避免哈希碰撞
opcache.max_accelerated_files=40000

; 缓存文件的最大大小（字节）
; 0 为不限制，允许缓存所有大小的文件
opcache.max_file_size=0

; ============================================================================
; 生产环境关键配置 - 性能调优
; ============================================================================

; 是否验证脚本时间戳
; 0: 不验证（生产环境核心配置）。PHP 将永远不检查文件更新，
; 代码发布时必须重启 PHP 进程（RoadRunner reload / restart）。
opcache.validate_timestamps=0

; 检查频率（秒）
; 当 validate_timestamps=0 时此配置无效，但建议设为 0 以防止意外开启时的性能损耗
opcache.revalidate_freq=0

; ============================================================================
; 优化与特性
; ============================================================================

; 启用文件存在覆盖检查
; 如果启用，OPcache 将在哈希表中检查文件是否存在
; 可以避免每次请求都进行文件系统 stat 系统调用，提升性能
opcache.enable_file_override=1

; 文件缓存配置 (可选 - 通常不需要)
; 作用：将字节码缓存到磁盘。
; 场景：
; 1. 内存不足时作为二级缓存 fallback。
; 2. 服务器重启后加速“冷启动”（Warmup）。
; 弊端：Docker 容器中磁盘 I/O 较慢且通常是临时的。
; 建议：由于 RoadRunner 是常驻进程且我们分配了充足内存 (384M)，
; 建议优先使用纯内存缓存以获得极致性能。除非为了减少启动时间，否则保持注释。
; opcache.file_cache=/tmp/opcache
; opcache.file_cache_only=0

; 启用快速关闭序列
; 允许在请求结束时不释放变量内存，依靠内存管理一次性释放
opcache.fast_shutdown=1

; 文件缓存一致性检查
; 验证缓存文件的完整性，防止加载损坏的缓存（稍微影响性能，但更安全）
opcache.file_cache_consistency_checks=1

; 记录警告日志
; 生产环境通常关闭，减少日志噪音
opcache.record_warnings=0

; ============================================================================
; 框架兼容性 (Laravel 等需要)
; ============================================================================

; 保存注释
; 框架（如 Laravel）通常需要保留文档注释以支持依赖注入、注解路由等功能
opcache.save_comments=1

; 加载注释
; 确保在从缓存加载脚本时也加载这些注释
opcache.load_comments=1

; ============================================================================
; 预加载 (Preload) - 极致性能
; ============================================================================
; 指定预加载脚本，在服务器启动时将核心框架文件加载到内存中
; 路径需要根据实际 Docker 容器内路径调整
; opcache.preload=/var/www/html/preload.php
; opcache.preload_user=www-data

; ============================================================================
; 其他
; ============================================================================

; 是否使用当前工作目录作为脚本键的一部分
; 1: 启用。防止不同目录下同名文件产生缓存冲突
opcache.use_cwd=1

; 内存浪费比例限制
; 当浪费的内存超过此百分比时，计划重启 OPcache（默认 5%）
opcache.max_wasted_percentage=10

