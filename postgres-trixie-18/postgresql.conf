# =============================================================================
# PostgreSQL 18.1 服务器优化配置 (2核1G内存)
# 专为 Docker 容器环境优化
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置 (2核1G优化)
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100                   # 双核可支持更多连接
superuser_reserved_connections = 3      # 适度增加保留连接
shared_preload_libraries = 'timescaledb,pg_cron' # 启用扩展
cron.database_name = 'postgres'          # pg_cron 运行的数据库

# TimescaleDB 配置
timescaledb.max_background_workers = 8  # TimescaleDB 预留后台进程
timescaledb.telemetry_level = off       # 关闭遥测报告，减少 Apache 版报错日志

# -----------------------------------------------------------------------------
# 内存设置 (1G内存优化)
# -----------------------------------------------------------------------------
shared_buffers = 256MB                  # 增加到内存的25%
effective_cache_size = 768MB            # 增加到内存的75%
work_mem = 2MB                          # 单查询内存(考虑更多并发连接)
maintenance_work_mem = 64MB             # 增加维护内存
temp_buffers = 8MB                      # 适度增加临时缓冲区

# -----------------------------------------------------------------------------
# WAL 设置 (2核1G优化)
# -----------------------------------------------------------------------------
wal_level = replica                     # 保持replica级别支持WAL流传输
max_wal_senders = 2                     # 双核可支持2个发送者
wal_buffers = 4MB                       # 增加WAL缓冲区
max_wal_size = 512MB                    # 增加WAL大小
min_wal_size = 128MB                    # 增加最小WAL大小
checkpoint_timeout = 10min              # 适度减少检查点间隔

# -----------------------------------------------------------------------------
# 查询优化 (双核优化 - 阿里云 ESSD PL1)
# -----------------------------------------------------------------------------
# random_page_cost: 随机页面访问成本
# - ESSD PL3: 1.0 (最高性能)
# - ESSD PL2: 1.1 (高性能)
# - ESSD PL1: 1.1 (推荐，性价比最高)
# - ESSD PL0: 1.2 (基础性能)
# - SSD云盘: 1.5
random_page_cost = 1.1

# effective_io_concurrency: 并发IO操作数
# - ESSD PL3: 300-500 (最大1,000,000 IOPS)
# - ESSD PL2: 200-300 (最大100,000 IOPS)
# - ESSD PL1: 150-200 (最大50,000 IOPS)
# - ESSD PL0: 100-150 (最大10,000 IOPS)
# - SSD云盘: 50-100
effective_io_concurrency = 150

# 并行查询与后台进程 (双核优化)
# -----------------------------------------------------------------------------
max_parallel_workers = 8                 # 总并行工作进程数
max_parallel_workers_per_gather = 2      # 每个查询最多2个并行进程 (匹配2核)
max_parallel_maintenance_workers = 2     # 维护操作并行进程
max_worker_processes = 16                # 总工作进程数 (需包含 TimescaleDB, Parallel, Autovacuum 等)

# -----------------------------------------------------------------------------
# 日志设置 (Docker 优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # 关闭日志收集器节省内存
log_min_messages = error                # 只记录错误日志
log_min_duration_statement = 5000       # 记录超过5秒的查询
log_connections = off
log_disconnections = off
log_line_prefix = '%t [%p]: '
log_checkpoints = off                   # 关闭检查点日志
log_timezone = 'Asia/Shanghai'          # 设置日志时区为上海时间

# -----------------------------------------------------------------------------
# 自动清理 (2核1G优化)
# -----------------------------------------------------------------------------
autovacuum_max_workers = 2              # 双核可使用2个清理进程
autovacuum_naptime = 1min               # 减少清理间隔
autovacuum_vacuum_scale_factor = 0.1    # 降低阈值增加清理频率
autovacuum_analyze_scale_factor = 0.05  # 降低分析阈值
autovacuum_work_mem = 32MB              # 增加清理内存使用

# -----------------------------------------------------------------------------
# 统计信息 (最小化)
# -----------------------------------------------------------------------------
track_io_timing = off                   # 关闭IO时间统计节省资源
default_statistics_target = 100         # 适度增加统计目标

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
statement_timeout = 60000               # 60秒超时防止长查询
lock_timeout = 30000                    # 30秒锁超时
idle_in_transaction_session_timeout = 120000  # 2分钟空闲超时
timezone = 'Asia/Shanghai'
extra_float_digits = 0                  # 保持默认浮点数精度

# -----------------------------------------------------------------------------
# 锁管理 (1核1G优化)
# -----------------------------------------------------------------------------
max_locks_per_transaction = 32          # 降低锁数量

# -----------------------------------------------------------------------------
# JIT编译 (禁用以节省资源)
# -----------------------------------------------------------------------------
jit = off                               # 禁用JIT编译节省CPU资源

# -----------------------------------------------------------------------------
# 后台写入优化 (双核优化)
# -----------------------------------------------------------------------------
bgwriter_delay = 50ms                   # 减少后台写入延迟
bgwriter_lru_maxpages = 200             # 增加每轮写入页数
bgwriter_lru_multiplier = 3.0           # 增加写入倍数

# -----------------------------------------------------------------------------
# 网络和连接优化
# -----------------------------------------------------------------------------
tcp_keepalives_idle = 120               # TCP保活空闲时间（2分钟）
tcp_keepalives_interval = 30            # TCP保活间隔（30秒）
tcp_keepalives_count = 3                # TCP保活次数

# -----------------------------------------------------------------------------
# 查询计划优化 (双核优化)
# -----------------------------------------------------------------------------
enable_partitionwise_join = on          # 启用分区智能连接
enable_partitionwise_aggregate = on     # 启用分区智能聚合
enable_parallel_append = on             # 启用并行追加
enable_parallel_hash = on               # 启用并行哈希
enable_partition_pruning = on           # 启用分区修剪

# -----------------------------------------------------------------------------
# 维护和监控
# -----------------------------------------------------------------------------
log_autovacuum_min_duration = 2000      # 记录超过2秒的自动清理
log_hostname = off                      # 不记录主机名节省日志空间
log_statement = 'none'                  # 不记录SQL语句
log_recovery_conflict_waits = off       # 不记录恢复冲突等待

# =============================================================================
# 2核1G 服务器优化配置结束
# =============================================================================
