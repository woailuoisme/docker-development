(proxy-octane-app-auth) {
	{args[0]} {
		import ../snippets/request-log.conf
		import ../snippets/security.conf
		import ../snippets/waf.conf
		encode zstd gzip

		# A. 定义需要受保护的路径匹配器
		@protected {
			path /docs*
			path /log-viewer*
			path /horizon*
		}

		# B. 处理所有受保护的请求 (应用认证)
		handle @protected {
			forward_auth authelia:9091 {
				uri /api/authz/forward-auth
				copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
			}
			# 认证通过后，代理到后端应用
			reverse_proxy {args[1]} {
				transport http {
					# 保持 128 个长连接 (默认 32)
					keepalive_idle_conns_per_host 128
					# 空闲连接保持时间 (默认 120s)
					keepalive 60s
					# 连接超时时间 (默认 3s)
					dial_timeout 2s
				}
			}
		}

		# C. Authelia 自身服务的代理 (不需要认证)
		handle /authelia* {
			reverse_proxy authelia:9091
		}

		# D. 处理所有其他请求 (不应用认证)
		# 这一块会处理根路径 / 和所有其他未被上面 handle 块捕获的路径。
		handle {
			reverse_proxy {args[1]} {
				transport http {
					# 保持 128 个长连接 (默认 32)，足以应对大多数高并发场景
					keepalive_idle_conns_per_host 128
					# 1 分钟左右比较稳健 (默认 120s)
					keepalive 60s
					# 快速失败：2s 连不上就报错 (默认 3s)
					dial_timeout 2s
				}
			}
		}
	}
}
