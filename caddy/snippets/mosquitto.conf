# ===================================================================
# MQTT over TLS (MQTTS) 配置
# ===================================================================
# 重要说明：
# 1. layer4 的 tls handler 本身不管理证书，只负责 TLS 终止
# 2. 必须通过 Caddy 的 HTTP/HTTPS 服务器来自动获取证书
# 3. 推荐在主 Caddyfile 中配置 HTTPS 服务器块来获取证书
# ===================================================================

layer4 {
	:8883 {
		# 匹配 MQTT TLS 连接（通过 SNI）
		@mqtt tls sni mqtt.{$SITE_ADDRESS}

		route @mqtt {
			# TLS 终止 - 使用 Caddy 已获取的证书
			# 注意：tls handler 不需要额外参数，会自动使用 Caddy 管理的证书
			tls
			# 代理到后端 mosquitto 服务（明文连接）
			proxy mosquitto:1883
		}
	}
}
