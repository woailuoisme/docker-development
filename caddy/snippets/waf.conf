# ============================================
# WAF (Web Application Firewall) 规则
# Caddy Web 应用防火墙配置
# ============================================
#
# 功能说明：
#   拦截常见的 Web 攻击，包括：
#   - 恶意扫描工具和爬虫
#   - 敏感文件访问
#   - 路径遍历攻击
#   - SQL 注入攻击
#   - XSS 跨站脚本攻击
#   - 文件包含攻击
#   - 恶意请求方法
#
# 使用方法：
#   在 Caddyfile 站点配置中导入此文件
#
#   示例 1 - 直接导入：
#   example.com {
#       import /etc/caddy/snippets/waf.conf
#       reverse_proxy localhost:8080
#   }
# 注意事项：
#   - 规则可能会误拦截正常请求，请根据实际情况调整
#   - 建议先在测试环境验证后再部署到生产环境
#   - 可以注释掉不需要的规则
#
# ============================================


# --------------------------------------------
# 1. 恶意扫描工具和爬虫检测
# --------------------------------------------
# 拦截常见的安全扫描工具和恶意爬虫
# 包括：sqlmap、nmap、nikto、acunetix 等
# 这些工具通常用于探测网站漏洞
@bad_bot {
	header_regexp User-Agent (?i)(sqlmap|nmap|nikto|acunetix|dirbuster|masscan|nuclei|gobuster|burpsuite|wfuzz|ffuf|zgrab|censys|shodan)
}

handle @bad_bot {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 2. 敏感文件访问防护
# --------------------------------------------
# 阻止访问配置文件、备份文件、版本控制文件等
# 这些文件可能包含敏感信息（数据库密码、API 密钥等）
#
# 拦截的文件类型和目录：
#   - 版本控制: .git, .gitignore, .svn, .hg
#   - 环境/配置: .env, .config, .htaccess, .htpasswd, web.config, nginx.conf
#   - 依赖管理: composer.*, package*.json, yarn.lock, pnpm-lock.yaml
#   - 数据库/备份: .sql, .sql.gz, .bak, .old, .backup, /backup/, /database/
#   - 开发/IDE: .idea, .vscode, .project, artisan, server.php, Dockerfile
#   - 证书/密钥: .pem, .key, .crt, .cer, .pfx
#   - 临时/日志: .log, .tmp, .swp, *~
@sensitive_files {
	path_regexp (?i)(\.env.*|\.git|\.svn|\.sql|\.bak|\.log|\.config|\.htaccess|\.htpasswd|composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|pnpm-lock\.yaml|Dockerfile|\.dockerignore|artisan|server\.php|wp-config\.php|.*\.sql(\.gz)?|\.old|\.backup|\.tmp|\.idea|\.vscode|\.pem|\.key|\.crt|\.nginx\.conf|web\.config)
}

handle @sensitive_files {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 3. 路径遍历攻击防护
# --------------------------------------------
# 阻止目录遍历攻击（Directory Traversal）
# 攻击者尝试通过 ../ 访问上级目录的敏感文件
#
# 拦截的模式：
#   - ../           Unix 目录遍历
#   - ..\           Windows 目录遍历
#   - /etc/passwd   Unix 用户文件
#   - /etc/shadow   Unix 密码文件
#   - /bin/sh       Unix Shell
#   - /bin/bash     Bash Shell
#   - cmd.exe       Windows 命令行
#   - powershell    PowerShell
@path_traversal {
	path_regexp (?i)(\.\.\/|\.\.\\|etc\/passwd|etc\/shadow|\/bin\/sh|\/bin\/bash|cmd\.exe|powershell)
}

handle @path_traversal {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 4. 管理后台路径防护
# --------------------------------------------
# 隐藏常见的管理后台入口
# 返回 404 而不是 403，避免暴露后台存在
#
# 拦截的路径：
#   - /phpmyadmin   phpMyAdmin 数据库管理
#   - /adminer      Adminer 数据库管理
#   - /wp-admin     WordPress 后台
#   - /wp-login     WordPress 登录
#   - /administrator Joomla 后台
#   - /manager      Tomcat 管理
#   - /console      各种控制台
#   - /phpinfo      PHP 信息页面
@admin_paths {
	path_regexp (?i)^\/(phpmyadmin|adminer|administrator|manager|console|phpinfo)
}

handle @admin_paths {
	respond "404 Not Found" 404
}

# --------------------------------------------
# 5. 恶意请求方法防护
# --------------------------------------------
# 禁用不安全或不常用的 HTTP 方法
#
# 拦截的方法：
#   - TRACE    可用于 XST 攻击
#   - TRACK    TRACE 的别名
#   - DEBUG    调试方法
#   - CONNECT  代理隧道方法
@bad_methods {
	method TRACE TRACK DEBUG CONNECT
}

handle @bad_methods {
	respond "405 Method Not Allowed" 405
}

# --------------------------------------------
# 6. SQL 注入攻击防护
# --------------------------------------------
# 拦截常见的 SQL 注入攻击模式
# 注意：此规则基于 URL 路径匹配，无法完全覆盖所有攻击
#
# 拦截的模式：
#   - union select  联合查询注入
#   - insert into   插入注入
#   - delete from   删除注入
#   - drop table    删表攻击
#   - select from   查询注入
@sql_injection_path {
	path_regexp (?i)(union.*select|insert.*into|delete.*from|drop.*(table|database)|select.*from)
}

handle @sql_injection_path {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 7. XSS 跨站脚本攻击防护
# --------------------------------------------
# 拦截常见的 XSS 攻击模式
#
# 拦截的模式：
#   - <script      脚本标签
#   - javascript:  JavaScript 协议
#   - on\w+=       所有事件处理器 (onclick, onerror, onload 等)
@xss_path {
	path_regexp (?i)(<script|javascript:|on\w+\s*=)
}

handle @xss_path {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 8. 文件包含攻击防护 (LFI/RFI)
# --------------------------------------------
# 拦截本地文件包含（LFI）和远程文件包含（RFI）攻击
#
# 拦截的协议：
#   - file://    本地文件协议
#   - php://     PHP 流协议
#   - data://    数据协议
#   - expect://  Expect 协议
#   - zip://     ZIP 协议
#   - phar://    PHAR 协议
#   - glob://    Glob 协议
#   - dict://    字典协议
#   - gopher://  Gopher 协议
#   - ldap://    LDAP 协议
@file_inclusion_path {
	path_regexp (?i)(file:|php:|data:|expect:|zip:|phar:|glob:|dict:|gopher:|ldap:)
}

handle @file_inclusion_path {
	respond "403 Forbidden" 403
}

# --------------------------------------------
# 9. Log4Shell / JNDI 注入防护
# --------------------------------------------
# 拦截 Log4j 远程代码执行漏洞 (CVE-2021-44228)
#
# 拦截的模式：
#   - ${jndi:     JNDI 注入
#   - ${java:     Java 表达式
#   - ${env:      环境变量
#   - ${sys:      系统属性
#   - %24%7B      URL 编码的 ${
@log4shell {
	path_regexp (?i)(\$\{jndi:|\$\{java:|\$\{env:|\$\{sys:|\$\{lower:|\$\{upper:|%24%7Bjndi|%24%7Bjava|%24%7Benv|%24%7Bsys)
}

handle @log4shell {
	respond "403 Forbidden" 403
}
