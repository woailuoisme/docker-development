# https://github.com/mholt/caddy-l4/blob/master/docs/examples/postgres-over-tls.md
# The Postgres-over-TLS example shows how to proxy PostgreSQL connections
# while serving HTTPS on the same port (443/tcp).
#
# 注意：这个配置使用 listener_wrappers，需要放在全局配置块中
# 它允许在 443 端口同时处理 HTTPS 和 PostgreSQL over TLS
#
# 使用方法：在 Caddyfile 的全局配置块 {} 中导入此文件
# 例如：
# {
#     import snippets/postgres.conf
# }
#
# 配置示例（已禁用）：
servers {
	listener_wrappers {
		layer4 {
			@tls-pgsql tls {
				# including the ALPN condition below
				# lets Caddy serve HTTPS requests
				# for the same server name
				alpn postgresql
				sni pg.{$SITE_ADDRESS}
			}
			route @tls-pgsql {
				tls {
					# the connection policy below is required
					# if the matcher above has no ALPN condition,
					# otherwise it may be securely omitted
					connection_policy {
						# supported by PostgreSQL 17 or later
						alpn postgresql
					}
				}
				# decrypted traffic is presumed to be PostgreSQL,
				# so no other checks are made before proxying it
				proxy postgres:5432
			}
		}
		tls
	}
}
