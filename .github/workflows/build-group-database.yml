name: Build Group - Database Services

on:
  workflow_dispatch:
    inputs:
      # === æŽ§åˆ¶å¼€å…³ ===
      build_all:
        description: 'ðŸš€ æž„å»ºæ‰€æœ‰æ•°æ®åº“æœåŠ¡'
        type: boolean
        default: false
      
      build_mysql8:
        description: 'æž„å»º MySQL8'
        type: boolean
        default: false
      build_mongodb:
        description: 'æž„å»º MongoDB'
        type: boolean
        default: false
      build_redis:
        description: 'æž„å»º Redis'
        type: boolean
        default: false
      build_postgres_17:
        description: 'æž„å»º PostgreSQL 17'
        type: boolean
        default: false
      build_postgres_18:
        description: 'æž„å»º PostgreSQL 18 (Alpine)'
        type: boolean
        default: false
      build_postgres_18_trixie:
        description: 'æž„å»º PostgreSQL 18 (Trixie)'
        type: boolean
        default: false
      
      # === é€šç”¨å‚æ•° ===
      tag:
        description: 'é•œåƒæ ‡ç­¾ (e.g., latest)'
        required: true
        default: 'latest'

      # === ç‰ˆæœ¬å‚æ•° ===
      mysql_version:
        description: 'MySQL ç‰ˆæœ¬'
        required: false
        default: '8.4'
      mongo_version:
        description: 'MongoDB ç‰ˆæœ¬'
        required: false
        default: '8.0'
      redis_version:
        description: 'Redis ç‰ˆæœ¬'
        required: false
        default: '8.4-alpine'
      postgres17_version:
        description: 'PostgreSQL 17 ç‰ˆæœ¬'
        required: false
        default: '17.7-alpine'
      postgres18_version:
        description: 'PostgreSQL 18 ç‰ˆæœ¬'
        required: false
        default: '18.1-alpine3.23'
      postgres18_trixie_version:
        description: 'PostgreSQL 18 Trixie ç‰ˆæœ¬'
        required: false
        default: '18.1-trixie'

env:
  REGISTRY_DOCKERHUB: docker.io/jiaoio
  REGISTRY_REDHAT: quay.io/jiaoio

jobs:
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          MATRIX_JSON='[]'
          
          add_task() {
            local name=$1
            local context=$2
            local image=$3
            local version=$4
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". + [{\"name\": \"$name\", \"context\": \"$context\", \"image\": \"$image\", \"version\": \"$version\"}]")
          }
          
          BUILD_ALL=${{ inputs.build_all }}
          
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_mysql8 }}" == "true" ]] && add_task "mysql8" "./mysql8" "mysql8" "${{ inputs.mysql_version }}"
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_mongodb }}" == "true" ]] && add_task "mongodb" "./mongodb" "mongodb" "${{ inputs.mongo_version }}"
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_redis }}" == "true" ]] && add_task "redis" "./redis" "redis" "${{ inputs.redis_version }}"
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_postgres_17 }}" == "true" ]] && add_task "postgres-17" "./postgres-alpine-17" "postgres-17" "${{ inputs.postgres17_version }}"
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_postgres_18 }}" == "true" ]] && add_task "postgres-18" "./postgres-alpine-18" "postgres-18" "${{ inputs.postgres18_version }}"
          [[ "$BUILD_ALL" == "true" || "${{ inputs.build_postgres_18_trixie }}" == "true" ]] && add_task "postgres-18-trixie" "./postgres-trixie-18" "postgres-18" "${{ inputs.postgres18_trixie_version }}"
          
          echo "matrix={\"include\":$MATRIX_JSON}" >> $GITHUB_OUTPUT

  build-database:
    needs: matrix-builder
    if: ${{ fromJson(needs.matrix-builder.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    
    name: Build ${{ matrix.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.REDHAT_REGISTRY_TOKEN }}" | docker login quay.io -u "${{ secrets.REDHAT_REGISTRY_USERNAME }}" --password-stdin

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
             MYSQL_VERSION=${{ matrix.version }}
             MONGO_VERSION=${{ matrix.version }}
             REDIS_VERSION=${{ matrix.version }}
             POSTGRES_VERSION=${{ matrix.version }}
          tags: |
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ matrix.version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ matrix.version }}-latest
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ matrix.version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ matrix.version }}-latest
