# MQTT 消费者输入 - 告警数据
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["vending/machines/+/alerts"]
  data_format = "json_v2"
  client_id = "telegraf_alert_consumer"
  qos = 2
  
  # MQTT 认证
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  
  # 连接配置
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  
  # 持久会话配置 - 告警消息很重要，启用持久会话确保不丢失
  # 配合 qos=2 和 client_id 使用，离线时的告警消息会被保存
  persistent_session = true
  
  # Keepalive 设置 - 保持连接活跃
  # keepalive + ping_timeout 的总和决定了连接超时检测时间
  keepalive = "30s"
  ping_timeout = "10s"
  
  # JSON v2 配置
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "alerts"
    timestamp_path = "timestamp"
    timestamp_format = "2006-01-02T15:04:05Z07:00"
    
    # 标签字段
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "machine_id"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "alert_id"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "type"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "severity"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "resolved"
      type = "string"
    
    # 字符串字段
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "description"
      type = "string"
