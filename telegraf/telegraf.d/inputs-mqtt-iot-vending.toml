# MQTT 消费者配置 - 增加 optional=true 容错处理

# ==================== 1. 遥测解析 (Telemetry) ====================
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["v1/vm/+/telemetry"]
  data_format = "json_v2"
  client_id = "telegraf_iot_telemetry"
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "vm_telemetry"
    [[inputs.mqtt_consumer.topic_parsing]]
      topic = "v1/vm/+/telemetry"
      tags = "_/_/device_no/_"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "system.voltage"
      rename = "voltage"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "system.current"
      rename = "current"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "system.uptime"
      rename = "uptime"
      type = "int"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "system.door_closed"
      rename = "door_closed"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.freezer_temps.0"
      rename = "temp_zone_0"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.freezer_temps.1"
      rename = "temp_zone_1"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.freezer_temps.2"
      rename = "temp_zone_2"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.freezer_temps.3"
      rename = "temp_zone_3"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.ambient_temp"
      rename = "ambient_temp"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "environment.vibration_g"
      rename = "vibration_g"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "connectivity.rssi"
      rename = "rssi"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "location.lat"
      rename = "lat"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "location.lng"
      rename = "lng"

# ==================== 2. 关键事件解析 (Events) ====================
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["v1/vm/+/events"]
  data_format = "json_v2"
  client_id = "telegraf_iot_events"
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "vm_events"
    [[inputs.mqtt_consumer.topic_parsing]]
      topic = "v1/vm/+/events"
      tags = "_/_/device_no/_"

    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "event_type"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "data.order_id"
      rename = "order_id"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "data.channel_id"
      rename = "channel_id"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "data.error_code"
      rename = "error_code"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "data.g_force"
      rename = "g_force"
      optional = true

# ==================== 3. 设备状态解析 (Status) ====================
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["v1/vm/+/status"]
  data_format = "json_v2"
  client_id = "telegraf_iot_status"
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "vm_status"
    [[inputs.mqtt_consumer.topic_parsing]]
      topic = "v1/vm/+/status"
      tags = "_/_/device_no/_"

    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "status"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "firmware"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "hardware"
      optional = true

# ==================== 4. 指令响应解析 (Commands ACK) ====================
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["v1/vm/+/commands/ack"]
  data_format = "json_v2"
  client_id = "telegraf_iot_acks"
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "vm_command_acks"
    [[inputs.mqtt_consumer.topic_parsing]]
      topic = "v1/vm/+/commands/ack"
      tags = "_/_/device_no/_/_"

    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "status"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "cmd_id"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "result.duration_ms"
      rename = "execution_duration_ms"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "error.code"
      rename = "error_code"
      optional = true
