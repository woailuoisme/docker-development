# MQTT 消费者输入 - 售货机状态数据
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["vending/machines/+/status"]
  data_format = "json_v2"
  client_id = "telegraf_status_consumer"
  qos = 1
  
  # MQTT 认证
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  
  # 连接配置
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  
  # 持久会话配置
  persistent_session = false
  
  # Keepalive 设置 - 保持连接活跃
  # keepalive + ping_timeout 的总和决定了连接超时检测时间
  keepalive = "30s"
  ping_timeout = "10s"
  
  # JSON v2 配置
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "machine_status"
    timestamp_path = "timestamp"
    timestamp_format = "2006-01-02T15:04:05Z07:00"
    
    # 标签字段（用于索引和分组）
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "machine_id"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "location"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "type"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "status"
    
    # 基本字段
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "online"
      type = "bool"
    
    # 库存字段（扁平化 inventory 对象）
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "inventory.total_capacity"
      rename = "total_capacity"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "inventory.current_stock"
      rename = "current_stock"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "inventory.low_stock_alert"
      rename = "low_stock_alert"
      type = "bool"
    
    # 销售字段（扁平化 sales 对象）
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sales.transactions_last_hour"
      rename = "transactions_last_hour"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sales.revenue_last_hour"
      rename = "revenue_last_hour"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sales.popular_product"
      rename = "popular_product"
      type = "string"
    
    # 设备健康字段（扁平化 device_health 对象）
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "device_health.temperature"
      rename = "temperature"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "device_health.compressor_hours"
      rename = "compressor_hours"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "device_health.network_strength"
      rename = "network_strength"
      type = "int"
    
    # 支付系统字段（扁平化 payment_system 对象）
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "payment_system.cash_balance"
      rename = "cash_balance"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "payment_system.digital_payments_today"
      rename = "digital_payments_today"
      type = "int"
