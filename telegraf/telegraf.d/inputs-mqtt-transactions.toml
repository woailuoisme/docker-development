# MQTT 消费者输入 - 交易数据
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_HOST}:${MQTT_PORT}"]
  topics = ["vending/machines/+/transactions"]
  data_format = "json_v2"
  client_id = "telegraf_transaction_consumer"
  qos = 1
  
  # MQTT 认证
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  
  # 连接配置
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  
  # 持久会话配置
  persistent_session = false
  
  # Keepalive 设置 - 保持连接活跃
  # keepalive + ping_timeout 的总和决定了连接超时检测时间
  keepalive = "30s"
  ping_timeout = "10s"
  
  # JSON v2 配置
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "transactions"
    timestamp_path = "timestamp"
    timestamp_format = "2006-01-02T15:04:05Z07:00"
    
    # 标签字段
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "machine_id"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "transaction_id"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "product"
    
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "payment_method"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "success"
      type = "bool"
    
    # 数值字段
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "price"
      type = "float"
