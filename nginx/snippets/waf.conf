# WAF (Web 应用防护) 规则 (适用场景：防御 SQL 注入、XSS、恶意扫描及敏感文件泄露)
# 使用方式：在 server {} 块中 include /etc/nginx/snippets/waf.conf;

# --------------------------------------------
# 1. 恶意扫描工具和爬虫检测
# --------------------------------------------
if ($http_user_agent ~* (sqlmap|nmap|nikto|acunetix|dirbuster|masscan|nuclei|gobuster|burpsuite|wfuzz|ffuf|zgrab|censys|shodan)) {
    return 403 "403 Forbidden - Malicious Bot detected";
}

# --------------------------------------------
# 2. 敏感文件访问防护
# --------------------------------------------
location ~* (\.env.*|\.git|\.svn|\.sql|\.bak|\.log|\.config|\.htaccess|\.htpasswd|composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|pnpm-lock\.yaml|Dockerfile|\.dockerignore|artisan|server\.php|wp-config\.php|.*\.sql(\.gz)?|\.old|\.backup|\.tmp|\.idea|\.vscode|\.pem|\.key|\.crt|\.nginx\.conf|web\.conf) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - Sensitive file access denied";
}

# --------------------------------------------
# 3. 路径遍历攻击防护
# --------------------------------------------
location ~* (\.\.\/|\.\.\\|etc\/passwd|etc\/shadow|\/bin\/sh|\/bin\/bash|cmd\.exe|powershell) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - Path traversal attempt blocked";
}

# --------------------------------------------
# 4. 管理后台路径防护 (返回 404)
# --------------------------------------------
location ~* ^\/(phpmyadmin|adminer|wp-admin|wp-login|administrator|manager|console|phpinfo) {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# --------------------------------------------
# 5. 恶意请求方法防护
# --------------------------------------------
if ($request_method ~ ^(TRACE|TRACK|DEBUG|CONNECT)$ ) {
    return 405 "405 Method Not Allowed";
}

# --------------------------------------------
# 6. SQL 注入攻击防护
# --------------------------------------------
# 注意：Nginx 的 location 仅匹配 path。针对 Query String 的注入需额外检查。
if ($query_string ~* (union.*select|insert.*into|delete.*from|drop.*(table|database)|select.*from)) {
    return 403 "403 Forbidden - SQL Injection attempt blocked";
}
location ~* (union.*select|insert.*into|delete.*from|drop.*(table|database)|select.*from) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - SQL Injection attempt blocked";
}

# --------------------------------------------
# 7. XSS 跨站脚本攻击防护
# --------------------------------------------
if ($query_string ~* (<script|javascript:|on\w+\s*=)) {
    return 403 "403 Forbidden - XSS attempt blocked";
}
location ~* (<script|javascript:|on\w+\s*=) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - XSS attempt blocked";
}

# --------------------------------------------
# 8. 文件包含攻击防护 (LFI/RFI)
# --------------------------------------------
if ($query_string ~* (file:|php:|data:|expect:|zip:|phar:|glob:|dict:|gopher:|ldap:)) {
    return 403 "403 Forbidden - File inclusion attempt blocked";
}
location ~* (file:|php:|data:|expect:|zip:|phar:|glob:|dict:|gopher:|ldap:) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - File inclusion attempt blocked";
}

# --------------------------------------------
# 9. Log4Shell / JNDI 注入防护
# --------------------------------------------
if ($query_string ~* (\$\{jndi:|\$\{java:|\$\{env:|\$\{sys:|\$\{lower:|\$\{upper:|%24%7Bjndi|%24%7Bjava|%24%7Benv|%24%7Bsys)) {
    return 403 "403 Forbidden - Log4Shell attempt blocked";
}
location ~* (\$\{jndi:|\$\{java:|\$\{env:|\$\{sys:|\$\{lower:|\$\{upper:|%24%7Bjndi|%24%7Bjava|%24%7Benv|%24%7Bsys)) {
    deny all;
    access_log off;
    log_not_found off;
    return 403 "403 Forbidden - Log4Shell attempt blocked";
}
