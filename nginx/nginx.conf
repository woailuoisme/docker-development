user www-data;
worker_processes auto;
worker_cpu_affinity auto; # NGINX 1.29.x 自动优化
pid /var/run/nginx.pid;
daemon off;
worker_rlimit_nofile 65535;

load_module modules/ngx_http_zstd_filter_module.so;
load_module modules/ngx_http_zstd_static_module.so;
load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

events {
  worker_connections 20480; # 提高单进程连接上限
  multi_accept on;           # 尽可能多地接受新连接
  use epoll;                 # Linux 高效事件驱动
  accept_mutex off;          # reuseport 开启下建议关闭以提升性能
}

stream {
    include /etc/nginx/snippets/stream.conf;
}

http {
  server_tokens off;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;      # 适中的保持时间
  keepalive_requests 10000;  # 高并发下增加单连接请求数，减少连接重建
  reset_timedout_connection on; # 快速重置超时连接，释放内存
  types_hash_max_size 2048;
  client_max_body_size 20M;
  proxy_headers_hash_max_size 1024;
  proxy_headers_hash_bucket_size 128;

  # 优化后的缓冲区设置 (针对 1.29.x)
  client_body_buffer_size 128k;
  client_header_buffer_size 4k;      # 适配大型 Cookie/Header
  large_client_header_buffers 4 32k;
  client_max_body_size 100M;         # 提升默认上传大小

  # 安全与超时策略
  client_body_timeout 15s;
  client_header_timeout 15s;
  send_timeout 15s;

  # 连接限制区域定义
  # limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
  #    - 基于客户端IP地址创建连接限制区域
  #    - $binary_remote_addr: 客户端IP的二进制表示（节省内存）
  #    - zone=conn_per_ip: 区域名称为conn_per_ip
  #    - 10m: 分配10MB内存用于存储连接状态（可存储约16万个IP地址）
  #
  # limit_conn_zone $server_name zone=conn_per_server:10m;
  #    - 基于服务器名称创建连接限制区域
  #    - $server_name: 当前虚拟主机的服务器名称
  #    - zone=conn_per_server: 区域名称为conn_per_server
  #    - 10m: 分配10MB内存用于存储连接状态
  #
  # 注意：这些区域定义需要在http块中，实际限制在server或location块中应用
  limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
  limit_conn_zone $server_name zone=conn_per_server:10m;

  # 添加 resolver 配置（Docker 内部 DNS）
  resolver 127.0.0.11 valid=30s;  # valid=30s 表示缓存 30 秒
  resolver_timeout 10s;           # 解析超时时间

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # 安全检测配置已整合到 snippets/waf.conf 中
  # 速率限制与安全防御
  include /etc/nginx/snippets/anti-ddos.conf;

  # 日志性能优化 (高并发下使用缓冲区异步写入)
  access_log /dev/stdout main buffer=32k flush=1s;
  error_log  /dev/stderr warn;
  # 日志时间格式优化
  map $time_iso8601 $custom_time {
      default "${time_iso8601}";
      ~^([^T]+)T([^+-]+)(.*)$ "$1 $2$3";
  }

  log_format main '$remote_addr [$custom_time] "$status | ${request_time}s | $request" '
                  '${body_bytes_sent}B "$http_user_agent" "$http_referer"';

  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  gzip_types application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/plain text/x-component;

  # --------------------------------------------
  # Brotli 压缩配置
  # --------------------------------------------
  brotli on;
  brotli_comp_level 6;
  brotli_min_length 256;
  brotli_static on;
  brotli_types application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/plain text/x-component;

  # --------------------------------------------
  # Zstd 压缩配置
  # --------------------------------------------
  zstd on;
  zstd_comp_level 3;
  zstd_min_length 256;
  zstd_static on;
  zstd_types application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/plain text/x-component;

  # ============================================
  # SSL 全局优化与安全设置
  # ============================================
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers off; # TLS 1.3 推荐由浏览器选择最优算法

  # 会话缓存：10m 约可存储 40,000 个会话
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets on; # 启用会话票据，支持无状态重连

  # 现代加密套件 (针对 TLS 1.2 和 1.3 优化)
  ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';


  # 限流区域配置
  # limit_req_zone 参数说明：
  # - $binary_remote_addr：使用客户端IP地址的二进制表示作为键
  # - zone=auth_login:10m：创建名为auth_login的共享内存区域，大小10MB，用于存储IP地址访问记录
  # - rate=5r/m：限制速率为每分钟5个请求
  # - rate=10r/s：限制速率为每秒10个请求
  # - rate=30r/s：限制速率为每秒30个请求
  #
  # 速率限制策略说明：
  # 1. auth_login (5r/m) - 登录接口，防止暴力破解
  # 2. auth_global (10r/s) - 认证相关接口，中等保护
  # 3. general (30r/s) - 一般API和页面，宽松限制
  #
  # 实际应用时配合 burst 参数使用：
  # - burst: 突发请求缓冲数量
  # - nodelay: 立即处理突发请求（不延迟）
  # - delay: 延迟处理突发请求
  # - limit_req_status: 超过限制时返回的状态码（默认503）

  # 认证登录相关接口的限流 - 最严格（每分钟5个请求）
  limit_req_zone $binary_remote_addr zone=auth_login:10m rate=5r/m;

  # 全局认证相关接口的限流 - 中等严格（每秒10个请求）
  limit_req_zone $binary_remote_addr zone=auth_global:10m rate=10r/s;

  # 一般API和页面访问的限流 - 较宽松（每秒30个请求）
  limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

    # 默认server配置 - 统一错误处理
    # 这个配置会捕获所有未匹配的域名请求，提供统一的错误页面处理
    server {
      listen 80 default_server;
      server_name _;  # 匹配所有未被其他 server 处理的请求

      # 连接限制配置
      # limit_conn conn_per_ip 10;
      #    - 限制单个客户端IP地址最多同时建立10个连接
      #    - 防止单个IP发起连接耗尽攻击
      #    - 适用于防止DDoS攻击和资源滥用
      #
      # limit_conn conn_per_server 100;
      #    - 限制整个服务器最多同时处理100个连接
      #    - 防止服务器资源被耗尽
      #    - 保护服务器稳定性，避免过载
      #
      # 注意：这些限制需要根据实际业务需求和服务器性能进行调整
      # 对于高并发场景，可能需要适当提高限制值
#       limit_conn conn_per_ip 10;
#       limit_conn conn_per_server 100;

      # 引入整合后的 SSL, HTTP/2, HTTP/3 及安全配置
      include /etc/nginx/snippets/ssl.conf;

      # 全局限流配置
      # limit_req zone=global_base burst=20 nodelay;
      #    - zone=global_base: 使用全局基础限流区域
      #    - burst=20: 允许突发20个请求（超过基础速率后的缓冲）
      #    - nodelay: 立即处理突发请求，不延迟
      #    - 超过限制的请求会立即返回429状态码
      #
      # limit_req_status 429;
      #    - 设置限流返回状态码为429（Too Many Requests）
      #    - 比默认的503状态码更友好，明确表示请求频率过高
      #
      # 这种配置适合作为兜底保护，防止IP级别的DDoS攻击
#       limit_req zone=global_base burst=20 nodelay;
#       limit_req_status 429;
    }

  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-available/*.conf;

  # 高效文件缓存
  open_file_cache max=10000 idle_timeout=60s;
  open_file_cache_valid 60s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  charset UTF-8;
}
