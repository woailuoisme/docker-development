;;;
;;; PgBouncer 生产级配置 - 优化用于 Laravel Octane/RoadRunner
;;; 关键配置：Transaction Mode + 禁用预编译语句
;;; 注意：环境变量通过 entrypoint.sh 在启动时替换
;;;

[databases]
; 数据库连接配置
; 格式: dbname = host=hostname port=port dbname=database user=username pool_size=N
; 环境变量将在启动时替换：${POSTGRES_HOST}, ${POSTGRES_PORT}, ${POSTGRES_DB}
${POSTGRES_DB} = host=${POSTGRES_HOST} port=${POSTGRES_PORT} dbname=${POSTGRES_DB}

; 通配符配置 - 允许动态数据库连接
;* = host=${POSTGRES_HOST} port=${POSTGRES_PORT}

[pgbouncer]
;;;
;;; 基础配置
;;;
listen_addr = 0.0.0.0
listen_port = 15432
unix_socket_dir = /var/run/pgbouncer
unix_socket_mode = 0777

; 认证配置
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt
auth_hba_file =

;;;
;;; 连接池配置 (Octane/RoadRunner 优化)
;;; 环境变量：${MAX_CLIENT_CONN}, ${DEFAULT_POOL_SIZE}, ${MAX_DB_CONNECTIONS}
;;;
; 事务模式 - 必须！Laravel Octane 需要此模式
; 注意：使用此模式时，Laravel 必须设置 'prepare' => false
pool_mode = transaction

; 客户端连接数 = RoadRunner workers * 每个 worker 的数据库连接
; 例如：4 workers * 50 连接 = 200
max_client_conn = ${MAX_CLIENT_CONN}

; 默认连接池大小 - 每个数据库的后端连接数
; 建议：根据 PostgreSQL max_connections 和应用负载调整
; 公式：default_pool_size = (PostgreSQL max_connections - 保留连接) / 数据库数量
default_pool_size = ${DEFAULT_POOL_SIZE}

; 最小连接池大小 - 保持热连接
min_pool_size = ${MIN_POOL_SIZE}

; 保留连接池 - 处理突发流量
reserve_pool_size = ${RESERVE_POOL_SIZE}
reserve_pool_timeout = 3

; 单个数据库最大连接数
max_db_connections = ${MAX_DB_CONNECTIONS}

; 单个用户最大连接数
max_user_connections = ${MAX_USER_CONNECTIONS}

;;;
;;; 超时配置 (Octane 优化)
;;;
; 轮询后端服务器（负载均衡）
server_round_robin = 1

; 连接超时（秒）
server_connect_timeout = 15
server_login_retry = 15

; 查询超时 - 0 表示无限制（由 PostgreSQL 控制）
query_timeout = 0

; 查询等待超时 - 客户端等待连接的最大时间
query_wait_timeout = ${QUERY_WAIT_TIMEOUT}

; 客户端空闲超时 - 0 表示无限制（Octane 长连接）
client_idle_timeout = 0

; 客户端登录超时
client_login_timeout = 60

; 空闲事务超时 - 0 表示无限制
idle_transaction_timeout = 0

; 服务器空闲超时 - 回收空闲连接
server_idle_timeout = ${SERVER_IDLE_TIMEOUT}

; 服务器生命周期 - 定期回收连接（防止内存泄漏）
server_lifetime = ${SERVER_LIFETIME}

; 服务器健康检查间隔
server_check_delay = 60
server_check_query = SELECT 1

;;;
;;; 连接管理 (Octane 优化)
;;;
; 自动数据库空闲超时
autodb_idle_timeout = 3600

; 服务器重置查询 - Transaction Mode 下必须使用 DISCARD ALL
server_reset_query = DISCARD ALL
server_reset_query_always = 0

; 快速关闭 - 0 表示优雅关闭
server_fast_close = 0

;;;
;;; 日志配置
;;;
admin_users = postgres, pgbouncer
stats_users = postgres, pgbouncer
log_connections = ${LOG_CONNECTIONS}
log_disconnections = ${LOG_DISCONNECTIONS}
log_pooler_errors = 1
log_stats = 1
stats_period = 60
verbose = ${VERBOSE}
syslog = 0

;;;
;;; 性能优化
;;;
; 添加主机名到应用名称
application_name_add_host = 1

; 最大数据包大小
max_packet_size = 2147483647

; 数据包缓冲区大小
pkt_buf = 4096

; 发送缓冲区循环计数
sbuf_loopcnt = 5

; 暂停超时
suspend_timeout = 10

; TCP Keepalive 配置（保持长连接）
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_user_timeout = 0

;;;
;;; 安全配置
;;;
; 禁用 PQexec（安全）
disable_pqexec = 0

; 配置文件路径
conffile = /etc/pgbouncer/pgbouncer.ini
pidfile = /var/run/pgbouncer/pgbouncer.pid
logfile = /var/log/pgbouncer/pgbouncer.log

;;;
;;; 兼容性配置
;;;
; 忽略启动参数（避免连接失败）
ignore_startup_parameters = extra_float_digits,search_path,options

;;;
;;; Laravel Octane/RoadRunner 注意事项
;;;
; 1. 必须使用 Transaction Mode (pool_mode = transaction)
; 2. Laravel database.php 中必须设置: 'prepare' => false
; 3. 不支持 LISTEN/NOTIFY（如需要，请直连 PostgreSQL）
; 4. 不支持 PREPARE/EXECUTE（已通过 'prepare' => false 禁用）
; 5. 不支持 WITH HOLD CURSOR（事务模式限制）
;
