# Mosquitto MQTT Broker 生产环境优化配置
# 版本: 2.0.22

# =================================================================
# 监听器配置
# =================================================================
listener 1883 0.0.0.0
protocol mqtt
# 性能优化：降低延迟（禁用 Nagle 算法）
set_tcp_nodelay true

# =================================================================
# 认证与安全
# =================================================================
# 仅有一个监听器时，不需要开启 per_listener_settings，避免持久化会话关联错误
# per_listener_settings true

password_file /mosquitto/config/passwd
allow_anonymous false

# =================================================================
# 持久化与会话
# =================================================================
persistence true
persistence_location /mosquitto/data/
persistence_file mosquitto.db
# 自动保存间隔（秒）
autosave_interval 300

# 生产环境建议：过期清理 (1天)，防止持久客户端堆积导致性能下降
persistent_client_expiration 1d

# =================================================================
# 资源限制 (预防 OOM 和恶意攻击)
# =================================================================
# 限制单个包大小 (10MB，保护内存)
max_packet_size 10485760
# 允许的最大并发连接 (-1 为无限制，受系统句柄限制)
max_connections -1
# QoS 1/2 待处理队列长度
max_queued_messages 2000
# 并发飞行消息数 (提高吞吐量)
max_inflight_messages 40

# =================================================================
# 日志配置
# =================================================================
# Docker 建议保留 stdout，方便驱动收集
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log

# 生产环境仅记录 Error 和 Warning，减少 IO 压力
log_type error
log_type warning
# log_type notice
# log_type information

connection_messages true
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# 系统状态更新频率 ($SYS 主题)，调大以减少内部开销
sys_interval 60

# =================================================================
# 功能配置
# =================================================================
retain_available true
allow_zero_length_clientid true
auto_id_prefix auto-
