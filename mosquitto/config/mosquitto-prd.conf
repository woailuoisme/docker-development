# Mosquitto MQTT Broker 配置文件
# 版本: 2.0.22
# 环境: 生产环境 (Production)
# 
# 生产环境配置特点：
# - 强制认证，禁用匿名访问
# - 优化的日志级别（减少 debug 信息）
# - 更严格的连接和消息限制
# - 持久化客户端会话管理
# - 性能优化配置

# =================================================================
# 监听器配置
# =================================================================

# MQTT 原生协议监听器
listener 1883 0.0.0.0
protocol mqtt

# WebSocket 监听器（如果需要 Web 客户端）
listener 9001 0.0.0.0
protocol websockets

# =================================================================
# 安全和认证配置
# =================================================================

# 强制使用密码认证
password_file /mosquitto/config/passwd

# 生产环境必须禁用匿名访问
allow_anonymous false

# 允许零长度客户端 ID（由 broker 自动生成）
allow_zero_length_clientid true

# 自动生成的客户端 ID 前缀
auto_id_prefix mqtt-client-

# =================================================================
# 持久化配置
# =================================================================

# 启用持久化（生产环境必须）
persistence true
persistence_location /mosquitto/data/
persistence_file mosquitto.db

# 自动保存间隔：5分钟（生产环境建议更频繁）
autosave_interval 300

# 持久客户端过期时间：7天未连接则清理会话
# 格式：数字 + 单位 (h=小时, d=天, w=周, m=月, y=年)
persistent_client_expiration 7d

# =================================================================
# 日志配置（生产环境优化）
# =================================================================

# 日志输出目标
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log

# 生产环境日志级别（不包括 debug）
log_type error
log_type warning
log_type notice
log_type information

# 记录客户端连接/断开事件
connection_messages true

# 生产环境可选：记录订阅事件（用于审计）
log_type subscribe
log_type unsubscribe

# 日志时间戳配置
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# =================================================================
# 连接和性能限制
# =================================================================

# 最大并发连接数（根据服务器资源调整）
# -1 = 无限制，生产环境建议设置具体值
max_connections 10000

# 每个客户端的最大排队消息数
max_queued_messages 1000

# 每个客户端的最大排队消息字节数（100MB）
max_queued_bytes 104857600

# QoS 1/2 消息的最大并发传输数
max_inflight_messages 20

# 最大 keepalive 时间（秒）
# 客户端请求的 keepalive 不能超过此值
max_keepalive 300

# 最大消息大小（10MB）
message_size_limit 10485760

# 最大数据包大小（10MB）
max_packet_size 10485760

# =================================================================
# 功能配置
# =================================================================

# 启用保留消息功能
retain_available true

# 保留消息过期检查间隔（分钟）
# 每小时检查一次过期的保留消息
retain_expiry_interval 60

# QoS 0 消息排队（当持久客户端断开时）
queue_qos0_messages false

# 禁用 TCP Nagle 算法，降低延迟
set_tcp_nodelay true

# $SYS 主题更新间隔（秒）
sys_interval 60

# =================================================================
# 内存管理（可选）
# =================================================================

# 内存限制（字节）- 根据服务器资源设置
# 例如：2GB = 2147483648
# memory_limit 2147483648

# =================================================================
# 运行用户（仅在以 root 启动时有效）
# =================================================================

# 切换到非特权用户运行
user mosquitto
